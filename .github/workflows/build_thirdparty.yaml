# https://github.com/tsukumijima/KonomiTV/blob/v0.12.0/.github/workflows/build_thirdparty.yaml
name: Build Thirdparty Libraries
# 手動実行
on:
  workflow_dispatch:
# 各サードパーティーライブラリのバージョン
env:
  # Python のバージョン (Python Standalone Builds のリリースを指定する)
  ## ref: https://github.com/indygreg/python-build-standalone/releases
  PYTHON_TAG: "20250106"
  PYTHON_MAJOR_VERSION: "3.11"
  PYTHON_VERSION: "3.11.11"
  # Poetry のバージョン
  POETRY_VERSION: "1.8.5"
  # FFmpeg のバージョン (FFmpeg-Builds のリリースを指定する)
  ## FFmpeg-Builds は毎月末のリリースが長期間保持されるため、基本毎月末のリリースを指定する
  ## FFMPEG_HWENCC_* は QSVEncC・NVEncC・VCEEncC (for Ubuntu 20.04 LTS) が依存する FFmpeg のバージョンを示す
  ## FFmpeg-Builds の最新リリースでは FFmpeg 4.4 系がビルドされなくなったため、FFMPEG_HWENCC_* は 4.4 系の最終ビルドで固定されている
  ## (正確には Ubuntu 20.04 LTS で入る FFmpeg は 4.2 系だが、FFmpeg 4.x 系であれば ABI 互換性があるため 4.4 系でも動作する)
  ## ref: https://github.com/BtbN/FFmpeg-Builds/releases
  FFMPEG_TAG: "autobuild-2024-12-31-13-02"
  FFMPEG_MAJOR_VERSION: "7.1"
  FFMPEG_VERSION: "7.1-62-gb168ed9b14"
  FFMPEG_HWENCC_TAG: "autobuild-2024-03-31-17-28"
  FFMPEG_HWENCC_MAJOR_VERSION: "4.4"
  FFMPEG_HWENCC_VERSION: "4.4.4-94-g5d07afd482"
  # libmediainfo のバージョン
  ## Windows 版の pymediainfo (ビルド済みの MediaInfo.dll が同梱されている) とバージョンを合わせる
  ## ref: https://github.com/sbraz/pymediainfo/blob/v6.0.1/appveyor.yml#L6
  LIBMEDIAINFO_VERSION: "22.09"
  # Akebi HTTPS Server ビルド用の Golang のバージョン
  GOLANG_VERSION: "1.21.13"
  # ビルド対象の tsreadex・psisiarc・Akebi のコミットハッシュ
  TSREADEX_COMMIT_HASH: "eddc8bca0de99627d3867259e7a6e777cbd3b3c6"
  PSISIARC_COMMIT_HASH: "6593a0f63aedaaecfac7682b51e267874a8ec549"
  AKEBI_COMMIT_HASH: "3ba9a548baaa882f55b209ab0040cd1691078e66"

# ジョブの定義
jobs:
  # Linux 向けのサードパーティーライブラリのビルド
  build-linux:
    runs-on: ubuntu-20.04
    steps:
      # サードパーティーライブラリの配置フォルダを作成
      - name: Create Thirdparty Folder
        run: mkdir thirdparty/

      # tsreadex のビルド
      - name: Build tsreadex
        run: |
          git clone https://github.com/xtne6f/tsreadex
          cd tsreadex/
          git checkout ${{ env.TSREADEX_COMMIT_HASH }}
          make
          mkdir ../thirdparty/tsreadex/
          cp tsreadex ../thirdparty/tsreadex/tsreadex.elf
          chmod a+x ../thirdparty/tsreadex/tsreadex.elf
          cp License.txt ../thirdparty/tsreadex/

      # psisiarc のビルド
      - name: Build psisiarc
        run: |
          git clone https://github.com/xtne6f/psisiarc
          cd psisiarc/
          git checkout ${{ env.PSISIARC_COMMIT_HASH }}
          make
          mkdir ../thirdparty/psisiarc/
          cp psisiarc ../thirdparty/psisiarc/psisiarc.elf
          chmod a+x ../thirdparty/psisiarc/psisiarc.elf
          cp License.txt ../thirdparty/psisiarc/

      # デフォルトで勝手にキャッシュされてる (?) Golang を削除
      # ここで削除しておかないと意図しないバージョンの Golang が使われてしまうことがある (?)
      - name: Remove Default Golang
        run: sudo rm -rf /opt/hostedtoolcache/go/*

      # Golang 環境のセットアップ
      - name: Setup Golang Environment
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GOLANG_VERSION }}
          cache: false

      # Akebi HTTPS Server のビルド
      - name: Build Akebi HTTPS Server
        run: |
          go env
          git clone https://github.com/tsukumijima/Akebi
          cd Akebi/
          git checkout ${{ env.AKEBI_COMMIT_HASH }}
          GOARCH=amd64 make build-https-server
          mkdir ../thirdparty/Akebi/
          cp akebi-https-server ../thirdparty/Akebi/akebi-https-server.elf
          chmod a+x ../thirdparty/Akebi/akebi-https-server.elf
          cp License.txt ../thirdparty/Akebi/

      # FFmpeg・QSVEncC・NVEncC・VCEEncC のアーカイブのダウンロードと配置
      # ドライバさえ入っていればスタンドアローンで実行できるように構成を工夫している
      - name: Download and Deploy Encoder Archives
        run: |
          # p7zip-full と patchelf のインストール
          ## patchelf は ELF バイナリに埋め込まれている rpath (動的ライブラリの検索パス) を変更するツールで、
          ## QSV/NV/VCEEncC に rpath を追加するために使う
          ## ref: https://stackoverflow.com/questions/13769141/can-i-change-rpath-in-an-already-compiled-binary
          sudo apt-get update
          sudo apt-get install -y p7zip-full patchelf

          # FFmpeg のアーカイブのダウンロード
          curl -LO https://github.com/BtbN/FFmpeg-Builds/releases/download/${{ env.FFMPEG_TAG }}/ffmpeg-n${{ env.FFMPEG_VERSION }}-linux64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}.tar.xz
          tar xvf ffmpeg-n${{ env.FFMPEG_VERSION }}-linux64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}.tar.xz
          mkdir thirdparty/FFmpeg/
          cp ffmpeg-n${{ env.FFMPEG_VERSION }}-linux64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/bin/* thirdparty/FFmpeg/
          cp -r ffmpeg-n${{ env.FFMPEG_VERSION }}-linux64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/lib/* thirdparty/FFmpeg/
          cp ffmpeg-n${{ env.FFMPEG_VERSION }}-linux64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/LICENSE.txt thirdparty/FFmpeg/License.txt
          rm -rf thirdparty/FFmpeg/pkgconfig
          mv thirdparty/FFmpeg/ffmpeg thirdparty/FFmpeg/ffmpeg.elf
          mv thirdparty/FFmpeg/ffprobe thirdparty/FFmpeg/ffprobe.elf
          rm thirdparty/FFmpeg/ffplay
          chmod a+x thirdparty/FFmpeg/ffmpeg.elf
          patchelf --set-rpath '$ORIGIN:$ORIGIN/../lib:$ORIGIN/../Library' thirdparty/FFmpeg/ffmpeg.elf
          chmod a+x thirdparty/FFmpeg/ffprobe.elf
          patchelf --set-rpath '$ORIGIN:$ORIGIN/../lib:$ORIGIN/../Library' thirdparty/FFmpeg/ffprobe.elf

          # QSVEncC for startup check hack
          mkdir thirdparty/QSVEncC/
          touch thirdparty/QSVEncC/QSVEncC.elf

          # NVEncC for startup check hack
          mkdir thirdparty/NVEncC/
          touch thirdparty/NVEncC/NVEncC.elf

          # VCEEncC for startup check hack
          mkdir thirdparty/VCEEncC/
          touch thirdparty/VCEEncC/VCEEncC.elf

      # Python Standalone Builds のダウンロードと poetry のインストール
      - name: Install Python Standalone Builds & pip & poetry
        run: |
          # Python 本体のダウンロード
          curl -L -o python.tar.gz https://github.com/indygreg/python-build-standalone/releases/download/${{ env.PYTHON_TAG }}/cpython-${{ env.PYTHON_VERSION }}+${{ env.PYTHON_TAG }}-x86_64-unknown-linux-gnu-install_only.tar.gz
          tar xvf python.tar.gz
          mv python/ thirdparty/Python/

          # poetry のインストール
          thirdparty/Python/bin/python -m pip install poetry==${{ env.POETRY_VERSION }}

      # サードパーティーライブラリを tar.xz で圧縮
      # ファイルサイズ縮減のため、圧縮をかなり強めに掛けている
      # ref: https://axelstudios.github.io/7z/#!/
      - name: Compress Thirdparty Libraries
        run: |
          tar cvf thirdparty-linux.tar thirdparty
          7z a -txz -m0=LZMA2 -mx=9 -md=128m -mfb=128 -mmt=on thirdparty-linux.tar.xz thirdparty-linux.tar

      # 7z で圧縮したサードパーティーライブラリを Artifact としてアップロード
      - name: Upload Thirdparty Libraries as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: thirdparty-linux.tar.xz
          path: thirdparty-linux.tar.xz

  # Linux (ARM) 向けのサードパーティーライブラリのビルド
  build-linux-arm:
    runs-on: ubuntu-20.04
    steps:
      # サードパーティーライブラリの配置フォルダを作成
      - name: Create Thirdparty Folder
        run: mkdir thirdparty/

      # QEMU のセットアップ
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64

      # Docker Buildx のセットアップ
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Dockerfile の作成
      - name: Create Dockerfile
        run: |
          cat <<EOF > Dockerfile
          ARG IMAGE
          FROM \${IMAGE}
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y build-essential pkg-config
          EOF

      # ARM64 版 Docker イメージのビルド
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: arm64v8/ubuntu:build
          platforms: linux/arm64
          build-args: IMAGE=arm64v8/ubuntu:20.04
          cache-from: type=gha,scope=arm64v8/ubuntu
          cache-to: type=gha,scope=arm64v8/ubuntu,mode=max
          load: true

      # tsreadex のビルド
      - name: Build tsreadex
        run: |
          git clone https://github.com/xtne6f/tsreadex
          cd tsreadex/
          git checkout ${{ env.TSREADEX_COMMIT_HASH }}
          docker run --rm -i -v $(pwd):/work -w /work arm64v8/ubuntu:build bash -c 'make'
          mkdir ../thirdparty/tsreadex/
          cp tsreadex ../thirdparty/tsreadex/tsreadex.elf
          chmod a+x ../thirdparty/tsreadex/tsreadex.elf
          cp License.txt ../thirdparty/tsreadex/

      # psisiarc のビルド
      - name: Build psisiarc
        run: |
          git clone https://github.com/xtne6f/psisiarc
          cd psisiarc/
          git checkout ${{ env.PSISIARC_COMMIT_HASH }}
          docker run --rm -i -v $(pwd):/work -w /work arm64v8/ubuntu:build bash -c 'make'
          mkdir ../thirdparty/psisiarc/
          cp psisiarc ../thirdparty/psisiarc/psisiarc.elf
          chmod a+x ../thirdparty/psisiarc/psisiarc.elf
          cp License.txt ../thirdparty/psisiarc/

      # デフォルトで勝手にキャッシュされてる (?) Golang を削除
      # ここで削除しておかないと意図しないバージョンの Golang が使われてしまうことがある (?)
      - name: Remove Default Golang
        run: sudo rm -rf /opt/hostedtoolcache/go/*

      # Golang 環境のセットアップ
      - name: Setup Golang Environment
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GOLANG_VERSION }}
          cache: false

      # Akebi HTTPS Server のビルド
      - name: Build Akebi HTTPS Server
        run: |
          go env
          git clone https://github.com/tsukumijima/Akebi
          cd Akebi/
          git checkout ${{ env.AKEBI_COMMIT_HASH }}
          GOARCH=arm64 make build-https-server
          mkdir ../thirdparty/Akebi/
          cp akebi-https-server ../thirdparty/Akebi/akebi-https-server.elf
          chmod a+x ../thirdparty/Akebi/akebi-https-server.elf
          cp License.txt ../thirdparty/Akebi/

      # FFmpeg・rkmppenc のアーカイブのダウンロードと配置
      # ドライバさえ入っていればスタンドアローンで実行できるように構成を工夫している
      - name: Download and Deploy Encoder Archives
        run: |
          # p7zip-full と patchelf のインストール
          ## patchelf は ELF バイナリに埋め込まれている rpath (動的ライブラリの検索パス) を変更するツールで、
          ## rkmppenc に rpath を追加するために使う
          ## ref: https://stackoverflow.com/questions/13769141/can-i-change-rpath-in-an-already-compiled-binary
          sudo apt-get update
          sudo apt-get install -y p7zip-full patchelf

          # FFmpeg のアーカイブのダウンロード
          curl -LO https://github.com/BtbN/FFmpeg-Builds/releases/download/${{ env.FFMPEG_TAG }}/ffmpeg-n${{ env.FFMPEG_VERSION }}-linuxarm64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}.tar.xz
          tar xvf ffmpeg-n${{ env.FFMPEG_VERSION }}-linuxarm64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}.tar.xz
          mkdir thirdparty/FFmpeg/
          cp ffmpeg-n${{ env.FFMPEG_VERSION }}-linuxarm64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/bin/* thirdparty/FFmpeg/
          cp -r ffmpeg-n${{ env.FFMPEG_VERSION }}-linuxarm64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/lib/* thirdparty/FFmpeg/
          cp ffmpeg-n${{ env.FFMPEG_VERSION }}-linuxarm64-gpl-shared-${{ env.FFMPEG_MAJOR_VERSION }}/LICENSE.txt thirdparty/FFmpeg/License.txt
          rm -rf thirdparty/FFmpeg/pkgconfig
          mv thirdparty/FFmpeg/ffmpeg thirdparty/FFmpeg/ffmpeg.elf
          mv thirdparty/FFmpeg/ffprobe thirdparty/FFmpeg/ffprobe.elf
          rm thirdparty/FFmpeg/ffplay
          chmod a+x thirdparty/FFmpeg/ffmpeg.elf
          patchelf --set-rpath '$ORIGIN:$ORIGIN/../lib:$ORIGIN/../Library' thirdparty/FFmpeg/ffmpeg.elf
          chmod a+x thirdparty/FFmpeg/ffprobe.elf
          patchelf --set-rpath '$ORIGIN:$ORIGIN/../lib:$ORIGIN/../Library' thirdparty/FFmpeg/ffprobe.elf

          # rkmppenc for startup check hack
          mkdir thirdparty/rkmppenc/
          touch thirdparty/rkmppenc/rkmppenc.elf

      # Python Standalone Builds のダウンロードと poetry のインストール
      - name: Install Python Standalone Builds & pip & poetry
        run: |
          # Python 本体のダウンロード
          curl -L -o python.tar.gz https://github.com/indygreg/python-build-standalone/releases/download/${{ env.PYTHON_TAG }}/cpython-${{ env.PYTHON_VERSION }}+${{ env.PYTHON_TAG }}-aarch64-unknown-linux-gnu-install_only.tar.gz
          tar xvf python.tar.gz
          mv python/ thirdparty/Python/

          # poetry のインストール
          cd thirdparty/Python/
          docker run --rm -i -v $(pwd):/work -w /work arm64v8/ubuntu:build bash -c './bin/python -m pip install poetry==${{ env.POETRY_VERSION }}'

      # サードパーティーライブラリを tar.xz で圧縮
      # ファイルサイズ縮減のため、圧縮をかなり強めに掛けている
      # ref: https://axelstudios.github.io/7z/#!/
      - name: Compress Thirdparty Libraries
        run: |
          tar cvf thirdparty-linux-arm.tar thirdparty
          7z a -txz -m0=LZMA2 -mx=9 -md=128m -mfb=128 -mmt=on thirdparty-linux-arm.tar.xz thirdparty-linux-arm.tar

      # 7z で圧縮したサードパーティーライブラリを Artifact としてアップロード
      - name: Upload Thirdparty Libraries as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: thirdparty-linux-arm.tar.xz
          path: thirdparty-linux-arm.tar.xz
